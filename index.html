<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<title>Music Tags ‚Ä¢ DJ Toolkit</title>

<style>
  :root{
    --bg:#0f0f12; --card:#17181d; --card-2:#1e2026; --text:#e8eef6; --muted:#9aa4b2;
    --brand:#00e6e6; --brand-2:#62fff6; --ring:0 0 0 2px rgba(0,230,230,.25);
    --shadow:0 8px 30px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI Emoji", "Noto Color Emoji", "Apple Color Emoji",
               "Twemoji Mozilla", "EmojiOne Color", sans-serif,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";
    background:radial-gradient(1200px 800px at 20% -10%, #122027 0%, transparent 60%), var(--bg);
    color:var(--text);
    -webkit-tap-highlight-color:transparent;
    overflow-x:hidden;
  }

  .wrap{
    width:min(980px,92vw);
    margin:0 auto;
    padding:calc(env(safe-area-inset-top,0px)+18px) 0 40px;
  }

  .title{
    display:flex;gap:.6rem;align-items:center;
    color:var(--brand);
    margin:8px 4px 14px;
    font-weight:800;letter-spacing:.2px;font-size:1.45rem;
    text-shadow:0 0 22px rgba(0,230,230,.2);
  }

  .card{
    background:linear-gradient(180deg,var(--card) 0%,var(--card-2) 100%);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.05);
    margin:10px 0 18px;
    overflow:visible;
    position:relative;
    z-index:auto;
  }

  #notaGenero {
    margin-top: 6px;
    font-size: 0.9rem;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 8px 10px;
    line-height: 1.3;
    transition: all 0.3s ease;
  }

  .hint{
    margin-top:8px; color:var(--muted); font-size:.88rem; display:flex; align-items:center; gap:.5rem;
  }
  .hint-label{opacity:.9; font-weight:700}
  .badges{display:flex; gap:.5rem; flex-wrap:wrap}
  .badge{
    padding:.25rem .55rem; border:1px solid rgba(255,255,255,.10);
    background:#0e1014; border-radius:999px; font-weight:600;
  }
  .badge--active{
    border-color: rgba(0,230,230,.45);
    box-shadow: 0 0 0 2px rgba(0,230,230,.15) inset;
  }

  .radio-grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:620px){.radio-grid{grid-template-columns:1fr 1fr}}

  .radio-chip{
    display:flex;align-items:center;gap:.75rem;
    padding:12px 14px;border-radius:12px;
    background:#121317;
    border:1px solid rgba(255,255,255,.06);
    transition:transform .05s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    cursor:pointer;min-height:48px;
  }
  .radio-chip:hover{background:#14161b;border-color:rgba(255,255,255,.12)}
  .radio-chip input{appearance:none;width:18px;height:18px;border-radius:50%;border:2px solid var(--brand)}
  .radio-chip input:checked{background:var(--brand);box-shadow:inset 0 0 0 3px #121317}

  .selectors{display:grid;gap:12px;grid-template-columns:1fr;margin-top:6px}
  @media(min-width:720px){.selectors{grid-template-columns:1fr 1fr}}

  .search-box,.bpm-box{position:relative;display:flex;flex-direction:column}
  .search-box input,.bpm-box input{
    width:100%;height:46px;padding:10px 14px;
    border-radius:12px;border:1px solid rgba(255,255,255,.08);
    background:#0e1014;color:var(--text);
  }
  .search-box input:focus,.bpm-box input:focus{box-shadow:var(--ring);border-color:rgba(0,230,230,.35)}
  .bpm-box input.off{opacity:.45}

  .list{
    position:absolute;
    top:calc(100% + 6px);
    left:0;right:0;
    max-height:190px;overflow:auto;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.06);
    background:#0e1014;
    z-index:9999;
    box-shadow:0 14px 30px rgba(0,0,0,.45);
  }
  #generoList, #eventoList { z-index: 9999; }
  #faseList { z-index: 10000; }

  .item{padding:12px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.05)}
  .item:last-child{border-bottom:none}
  .item:hover{background:#14161b}

  .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}

  .version-group{
    align-self:flex-start;display:flex;flex-wrap:wrap;gap:12px;
    padding:6px 10px;margin:6px 0 8px;
    background:#121317;border:1px solid rgba(255,255,255,.08);
    border-radius:10px;color:var(--muted);
  }
  .version-group label{display:inline-flex;align-items:center;gap:.35rem;cursor:pointer}
  .version-group input[type="checkbox"]{width:16px;height:16px;transform:scale(1);accent-color:var(--brand)}
  .version-group input[type="radio"]{transform:scale(1.1);accent-color:var(--brand)}

  .results-grid{
    display:grid;gap:10px;grid-template-columns:1fr 1fr;
    position:relative;z-index:0;
  }
  @media(max-width:720px){.results-grid{grid-template-columns:1fr}}

  .result-card{display:flex;gap:8px;align-items:stretch;position:relative;z-index:0;}
  .result-card .textarea-box{flex:1;display:flex;flex-direction:column}
  .sub{font-size:.9rem;font-weight:700;color:var(--muted);margin-bottom:4px;letter-spacing:.05em}

  textarea.result{
    width:100%;height:56px;padding:12px 14px;
    background:#0d0f13;color:var(--brand-2);
    border:1px solid rgba(0,230,230,.35);
    border-radius:12px;resize:none;font-size:.98rem;line-height:1.2;
  }
  #albumText{color:#dfe6f3;border-color:rgba(255,255,255,.15)}

  .btn{
    min-width:110px;min-height:56px;padding:0 18px;
    border-radius:12px;border:1px solid rgba(255,255,255,.09);
    background:linear-gradient(180deg,#0f1116 0%,#10141b 100%);
    color:var(--text);font-weight:700;letter-spacing:.2px;
    cursor:pointer;box-shadow:var(--shadow);
  }
  .btn:active{transform:translateY(1px)}
  .btn--brand{
    background:linear-gradient(180deg,rgba(0,230,230,.2) 0%,rgba(0,230,230,.08) 100%);
    border-color:rgba(0,230,230,.35);
  }
  .reset-row{display:flex;justify-content:center;margin-top:8px}
  .btn--reset{min-width:160px;background:linear-gradient(180deg,#3a1414 0%,#1f0b0b 100%);border-color:#c22;color:#fff}

  .btn-open-modal{
    margin-top:6px;
    align-self:flex-end;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    font-size:.8rem;
    cursor:pointer;
  }
  .btn-open-modal:hover{
    background:rgba(255,255,255,.08);
    color:var(--text);
  }

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100000;
    padding:16px;
  }
  .modal-overlay.open{display:flex;}

  .modal-box{
    width:min(700px, 100%);
    background:#fdfdfd;
    color:#111;
    border-radius:12px;
    box-shadow:0 10px 40px rgba(0,0,0,.8);
    overflow:hidden;
    max-height:90vh;
    display:flex;
    flex-direction:column;
  }
  .modal-header{
    background:#222;
    color:#fff;
    padding:10px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-weight:700;
  }
  .modal-title{
    display:flex;
    align-items:center;
    gap:.4rem;
    color:#ff5252;
  }
  .modal-close{
    border:none;
    background:transparent;
    color:#fff;
    font-size:1.3rem;
    cursor:pointer;
  }
  .modal-body{
    padding:12px 14px 14px;
    background:#fafafa;
    flex:1;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .modal-body input{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:.95rem;
    outline:none;
  }
  .modal-body input:focus{
    border-color:#ff5252;
    box-shadow:0 0 0 2px rgba(255,82,82,.2);
  }
  .modal-list{
    border-radius:8px;
    border:1px solid #e0e0e0;
    background:#fff;
    overflow:auto;
    max-height:360px;
  }
  .modal-item{
    padding:8px 10px;
    border-bottom:1px solid #f0f0f0;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:.5rem;
  }
  .modal-item:last-child{border-bottom:none;}
  .modal-item:hover{
    background:#ffecec;
  }
  .modal-item span.emoji{
    font-size:1.1rem;
    width:1.5rem;
  }

  /* Chips de filtro del modal Evento */
  .modal-chips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-bottom:6px;
  }
  .chip-filter{
    border-radius:999px;
    border:1px solid #ddd;
    background:#fff;
    padding:3px 10px;
    font-size:.8rem;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .chip-filter span.emoji{
    font-size:1rem;
  }
  .chip-filter--active{
    background:#ff5252;
    border-color:#ff5252;
    color:#fff;
  }
  .modal-empty{
    padding:10px;
    font-size:.9rem;
    color:#666;
  }

  /* Ajuste visual para los √≠tems del modal de Ejemplos */
  .modal-item.mod-ejemplo{
    flex-direction:column;
    align-items:flex-start;
  }
  .mod-ejemplo-titulo{
    color:#007bff;
    font-size:.9rem;
    font-weight:600;
    margin:2px 0;
  }
  .mod-ejemplo-album{
    color:#555;
    font-size:.83rem;
    margin:1px 0 3px;
  }
  .mod-ejemplo-desc{
    color:#444;
    font-size:.8rem;
  }
  
  /* Modal Biblioteca Local (usa tu mismo estilo de modales) */
#modalLocalOverlay .modal-title { color:#00e6e6; }
.modal-tools{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.modal-chip{
  border-radius:999px; border:1px solid #ddd; background:#fff; padding:3px 10px;
  font-size:.8rem; cursor:default; color:#444;
}
.local-list-item{
  display:flex; flex-direction:column; gap:2px; padding:8px 10px;
  border-bottom:1px solid #f0f0f0; cursor:pointer;
}
.local-list-item:hover{ background:#ecfbff; }
.local-path{ font-size:.78rem; color:#666; }
.local-name{ font-weight:600; color:#0b2b3a; }
.local-empty{ padding:10px; font-size:.9rem; color:#666; }
.btn-mini{
  padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;
}
.btn-mini.brand{ border-color:#00e6e6; box-shadow:0 0 0 2px rgba(0,230,230,.15) inset; }

</style>
</head>
<body>

<div class="wrap">

  <div class="title">üßæ Estado del Tema</div>
  <section class="card">
    <div id="estadoGroup" class="radio-grid"></div>
  </section>

  <div class="title">üìä Popularidad</div>
  <section class="card">
    <div id="popularidadGroup" class="radio-grid"></div>
  </section>

  <div class="title">üéµ G√©nero ¬∑ üè∑Ô∏è Evento ¬∑ üéõÔ∏è Fase ¬∑ ‚è±Ô∏è BPM</div>
  <section class="card">
    <div class="selectors">
      <!-- G√âNERO -->
      <div class="search-box">
        <div class="sub">G√©nero</div>

        <div class="version-group">
          <label><input type="checkbox" id="chkGrupoAlVivo"> Grupo Al Vivo</label>
          <label><input type="radio" name="version" value="Original" checked> Original</label>
          <label><input type="radio" name="version" value="Rmxz"> Rmxz</label>
          <label><input type="radio" name="version" value="Mixz"> Mixz</label>
        </div>

        <input type="text" id="searchGenero" placeholder="Buscar g√©nero‚Ä¶" autocomplete="off" inputmode="text" />

        <button type="button" id="btnOpenGeneroModal" class="btn-open-modal">
          üìã Abrir lista grande
        </button>

        <div id="generoList" class="list"></div>

        <div class="hint">
          <span class="hint-label">Nota:</span>
          <span class="hint-text" id="notaGenero">(Selecciona un g√©nero para ver su nota BPM)</span>
        </div>
      </div>

      <!-- EVENTO -->
      <div class="search-box">
        <div class="sub">Evento</div>
        <input type="text" id="searchEvento" placeholder="Buscar evento‚Ä¶" autocomplete="off" inputmode="text" />

        <button type="button" id="btnOpenEventoModal" class="btn-open-modal">
          üìã Abrir lista grande
        </button>

        <div id="eventoList" class="list"></div>
      </div>

      <!-- FASE -->
      <div class="search-box">
        <div class="sub">Fase del set</div>
        <input type="text" id="searchFase" placeholder="Warm-up, Build-Up, Cl√≠max‚Ä¶" autocomplete="off" inputmode="text" />
        <div id="faseList" class="list"></div>
      </div>

      <!-- BPM -->
      <div class="bpm-box">
        <div class="sub">
          BPM
          <label style="margin-left:8px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="chkUsarBpm" checked style="accent-color: var(--brand); transform:scale(1.2);" />
            Usar
          </label>
        </div>
        <input type="number" id="bpm" placeholder="Ej. 95" min="50" max="220" step="1" inputmode="numeric" />
      </div>
    </div>
  </section>

  <!-- RESULTADOS -->
  <div class="title">üìå Resultados</div>
  <section class="card">
    <div class="results-grid">

      <div class="result-card">
        <div class="textarea-box">
          <div class="sub">üé§ Artista del √Ålbum</div>
          <textarea id="resultado" class="result" readonly></textarea>
        </div>
        <button id="btnCopyMain" class="btn btn--brand">Copiar</button>
      </div>

      <div class="result-card">
        <div class="textarea-box">
          <div class="sub">üíø √Ålbum</div>
          <textarea id="albumText" class="result" readonly></textarea>
        </div>
        <button id="btnCopyAlbum" class="btn">Copiar</button>
      </div>

      <div class="result-card" id="mixzCard" style="display:none;">
        <div style="flex:1;display:flex;flex-direction:column">
          <div class="sub">üé§ Artista: Bailable</div>
          <textarea id="bailableText" class="result" placeholder="Escribe el artista o tipo de mix..."></textarea>
        </div>
        <button id="btnCopyBailable" class="btn">Copiar</button>
      </div>

    </div>

    <div class="reset-row">
      <button id="btnReset" class="btn btn--reset">üîÑ Restablecer</button>
    </div>
  </section>

</div>

<!-- MODAL G√âNERO -->
<div id="modalGeneroOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üéµ Modal de G√©nero</div>
      <button type="button" id="btnCloseGeneroModal" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="text" id="modalSearchGenero" placeholder="Buscar g√©nero‚Ä¶" autocomplete="off" />
      <div id="modalGeneroList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- MODAL EVENTO (mejorado) -->
<div id="modalEventoOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üè∑Ô∏è Modal de Evento</div>
      <button type="button" id="btnCloseEventoModal" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="text" id="modalSearchEvento" placeholder="Buscar evento‚Ä¶" autocomplete="off" />

      <div id="modalEventoChips" class="modal-chips"></div>

      <div id="modalEventoList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- MODAL EJEMPLOS DE FORMATO -->
<div id="modalEjemploOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üìò Ejemplos de Formato</div>
      <button type="button" id="btnCloseEjemploModal" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="text" id="modalSearchEjemplo" placeholder="Buscar por g√©nero, t√≠tulo o palabra clave‚Ä¶" autocomplete="off" />
      <div id="modalEjemploList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- Botones de biblioteca local (ponlos donde te guste, por ejemplo bajo ‚ÄúResultados‚Äù) -->
<div class="wrap" style="margin-top:-10px;">
  <section class="card" style="padding:10px 14px;">
    <div class="row-between">
      <div class="sub">üéº Biblioteca local (√≠ndice en tu navegador)</div>
      <div class="modal-tools">
        <button id="btnPickFolder" class="btn-mini brand">üìÅ Cargar/Actualizar carpeta</button>
        <button id="btnOpenLocalModal" class="btn-mini">üîé Buscar en biblioteca</button>
        <button id="btnClearLocal" class="btn-mini">üóëÔ∏è Borrar cach√©</button>
      </div>
    </div>
  </section>
</div>

<!-- Fallback oculto para navegadores sin showDirectoryPicker -->
<input id="inputFolderFallback" type="file" webkitdirectory multiple style="display:none" />

<!-- MODAL: Biblioteca Local -->
<div id="modalLocalOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üéº Biblioteca local</div>
      <button type="button" id="btnCloseLocalModal" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-tools" style="justify-content:space-between;">
        <input type="text" id="searchLocal" placeholder="Buscar por nombre o ruta‚Ä¶" autocomplete="off" />
        <span class="modal-chip" id="localMetaChip">Sin √≠ndice cargado</span>
      </div>
      <div id="modalLocalList" class="modal-list"></div>
    </div>
  </div>
</div>


<script src="bdMusicData.js"></script>
<script src="bdMusicLite.js"></script>
<script>
  // Copiar principal
  document.getElementById('btnCopyMain').addEventListener('click', async () => {
    const txt = document.getElementById('resultado').value.trim();
    try{ await navigator.clipboard.writeText(txt); flashBtn('btnCopyMain'); }
    catch(e){ fallbackCopy('resultado'); flashBtn('btnCopyMain'); }
  });

  // Copiar √°lbum
  document.getElementById('btnCopyAlbum').addEventListener('click', async () => {
    const txt = document.getElementById('albumText').value.trim();
    try{ await navigator.clipboard.writeText(txt); flashBtn('btnCopyAlbum'); }
    catch(e){ fallbackCopy('albumText'); flashBtn('btnCopyAlbum'); }
  });

  // Copiar bailable
  document.getElementById('btnCopyBailable').addEventListener('click', async () => {
    const txt = document.getElementById('bailableText').value.trim();
    try{ await navigator.clipboard.writeText(txt); flashBtn('btnCopyBailable'); }
    catch(e){ fallbackCopy('bailableText'); flashBtn('btnCopyBailable'); }
  });

  // Restablecer b√°sico (el resto se completa en bdMusicLite)
  document.getElementById('btnReset').addEventListener('click', () => {
    localStorage.removeItem("estadoTag");
    localStorage.removeItem("popularidadTag");
    localStorage.removeItem("generoTag");
    localStorage.removeItem("eventoTag");
    localStorage.removeItem("faseTag");
    localStorage.removeItem("bpmTag");
    localStorage.removeItem("usarBpm");
    localStorage.removeItem("versionTag");
    localStorage.removeItem("grupoAlVivo");
    location.reload();
  });

  function fallbackCopy(id){
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
  }
  function flashBtn(id){
    const btn = document.getElementById(id);
    const old = btn.textContent;
    btn.textContent = '¬°Copiado!';
    setTimeout(()=>btn.textContent = old, 1200);
  }

  // Marcado visual de radios
  document.addEventListener('change', (ev)=>{
    if(ev.target.matches('input[name="estado"], input[name="popularidad"]')){
      const group = ev.target.name === 'estado' ? '#estadoGroup' : '#popularidadGroup';
      document.querySelectorAll(group + ' .radio-chip').forEach(l => l.classList.remove('is-checked'));
      ev.target.closest('.radio-chip')?.classList.add('is-checked');
    }
  });

  /* ===== MODAL G√âNERO ===== */
  const overlayGenero       = document.getElementById('modalGeneroOverlay');
  const btnOpenGenero       = document.getElementById('btnOpenGeneroModal');
  const btnCloseGenero      = document.getElementById('btnCloseGeneroModal');
  const modalSearchGenero   = document.getElementById('modalSearchGenero');
  const modalGeneroList     = document.getElementById('modalGeneroList');
  const generoInputMain     = document.getElementById('searchGenero');

  function abrirModalGenero(){
    if(!overlayGenero) return;
    overlayGenero.classList.add('open');
    modalSearchGenero.value = '';
    renderModalGeneros('');
    setTimeout(()=>modalSearchGenero.focus(), 50);
  }
  function cerrarModalGenero(){
    overlayGenero.classList.remove('open');
  }
  function renderModalGeneros(filtro){
    if(!Array.isArray(window.TB_Genero)) return;
    const f = (filtro || '').toLowerCase();
    modalGeneroList.innerHTML = '';
    window.TB_Genero
      .filter(g => g.Estado === 'ACT' && g.Nombre.toLowerCase().includes(f))
      .forEach(g => {
        const div = document.createElement('div');
        div.className = 'modal-item';

        let emoji = 'üéµ';
        let texto = g.Nombre;
        try{
          const m = g.Nombre.match(/^(\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*(.*)$/u);
          if(m){
            if(m[1]) emoji = m[1];
            if(m[2]) texto = m[2];
          }
        }catch{
          emoji = 'üéµ';
          texto = g.Nombre;
        }

        div.innerHTML = '<span class="emoji">' + emoji + '</span><span>' + texto + '</span>';
        div.addEventListener('click', ()=>{
          if(generoInputMain){
            generoInputMain.value = g.Nombre;
            const ev = new KeyboardEvent('keydown', {key:'Enter'});
            generoInputMain.dispatchEvent(ev);
          }
          cerrarModalGenero();
        });
        modalGeneroList.appendChild(div);
      });
  }
  btnOpenGenero?.addEventListener('click', abrirModalGenero);
  btnCloseGenero?.addEventListener('click', cerrarModalGenero);
  overlayGenero?.addEventListener('click', e=>{
    if(e.target === overlayGenero) cerrarModalGenero();
  });
  modalSearchGenero?.addEventListener('input', e=>renderModalGeneros(e.target.value));

  /* ===== MODAL EVENTO (MEJORADO) ===== */
  const overlayEvento       = document.getElementById('modalEventoOverlay');
  const btnOpenEvento       = document.getElementById('btnOpenEventoModal');
  const btnCloseEvento      = document.getElementById('btnCloseEventoModal');
  const modalSearchEvento   = document.getElementById('modalSearchEvento');
  const modalEventoList     = document.getElementById('modalEventoList');
  const modalEventoChips    = document.getElementById('modalEventoChips');
  const eventoInputMain     = document.getElementById('searchEvento');

  const _rawEventos = Array.isArray(window.TB_TipoEvento)
    ? window.TB_TipoEvento
    : (Array.isArray(window.TB_Evento) ? window.TB_Evento : []);

  const EV_DATA = _rawEventos.map(e => {
    let emoji = 'üè∑Ô∏è';
    let texto = e.Nombre;
    try {
      const m = e.Nombre.match(/^(\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*(.*)$/u);
      if (m) {
        if (m[1]) emoji = m[1];
        if (m[2]) texto = m[2];
      }
    } catch {
      emoji = 'üè∑Ô∏è';
      texto = e.Nombre;
    }
    return { ...e, emoji, texto };
  });

  const EV_EMOJIS = Array.from(new Set(EV_DATA.map(e => e.emoji)));
  let filtroEmojiEvento = 'ALL';

  function construirChipsEvento(){
    if (!modalEventoChips) return;
    modalEventoChips.innerHTML = '';

    const chipAll = document.createElement('button');
    chipAll.className = 'chip-filter chip-filter--active';
    chipAll.dataset.emoji = 'ALL';
    chipAll.innerHTML = '<span class="emoji">‚≠ê</span><span>Todos</span>';
    chipAll.addEventListener('click', onChipEventoClick);
    modalEventoChips.appendChild(chipAll);

    EV_EMOJIS.forEach(em => {
      const chip = document.createElement('button');
      chip.className = 'chip-filter';
      chip.dataset.emoji = em;
      chip.innerHTML = `<span class="emoji">${em}</span><span>${em}</span>`;
      chip.addEventListener('click', onChipEventoClick);
      modalEventoChips.appendChild(chip);
    });
  }

  function onChipEventoClick(ev){
    const emojiSel = ev.currentTarget.dataset.emoji || 'ALL';
    filtroEmojiEvento = emojiSel;

    document.querySelectorAll('#modalEventoChips .chip-filter')
      .forEach(ch => ch.classList.toggle('chip-filter--active', ch.dataset.emoji === emojiSel));

    renderModalEventos(modalSearchEvento.value);
  }

  function abrirModalEvento(){
    if (!overlayEvento) return;
    overlayEvento.classList.add('open');
    modalSearchEvento.value = '';
    filtroEmojiEvento = 'ALL';
    construirChipsEvento();
    renderModalEventos('');
    setTimeout(() => modalSearchEvento.focus(), 50);
  }

  function cerrarModalEvento(){
    overlayEvento.classList.remove('open');
  }

  function renderModalEventos(filtro){
    const f = (filtro || '').toLowerCase();
    modalEventoList.innerHTML = '';

    const filtrados = EV_DATA
      .filter(e => !e.Estado || e.Estado === 'ACT')
      .filter(e => filtroEmojiEvento === 'ALL' || e.emoji === filtroEmojiEvento)
      .filter(e => e.Nombre.toLowerCase().includes(f));

    if (!filtrados.length){
      const divEmpty = document.createElement('div');
      divEmpty.className = 'modal-empty';
      divEmpty.textContent = 'No se encontraron eventos con esos filtros.';
      modalEventoList.appendChild(divEmpty);
      return;
    }

    filtrados.forEach(e => {
      const div = document.createElement('div');
      div.className = 'modal-item';

      div.innerHTML = `
        <span class="emoji">${e.emoji}</span>
        <span>${e.texto}</span>
      `;

      div.addEventListener('click', () => {
        if (eventoInputMain) {
          eventoInputMain.value = e.Nombre;
          const ev = new KeyboardEvent('keydown', { key: 'Enter' });
          eventoInputMain.dispatchEvent(ev);
        }
        cerrarModalEvento();
      });

      modalEventoList.appendChild(div);
    });
  }

  btnOpenEvento?.addEventListener('click', abrirModalEvento);
  btnCloseEvento?.addEventListener('click', cerrarModalEvento);
  overlayEvento?.addEventListener('click', e => {
    if (e.target === overlayEvento) cerrarModalEvento();
  });
  modalSearchEvento?.addEventListener('input', e => renderModalEventos(e.target.value));

  /* ===== MODAL EJEMPLOS DE FORMATO ===== */
  const overlayEjemplo      = document.getElementById('modalEjemploOverlay');
  const btnCloseEjemplo    = document.getElementById('btnCloseEjemploModal');
  const modalSearchEjemplo = document.getElementById('modalSearchEjemplo');
  const modalEjemploList   = document.getElementById('modalEjemploList');
  const resultadoTxt       = document.getElementById('resultado');
  const albumTxt           = document.getElementById('albumText');

  function abrirModalEjemplo(){
    if (!overlayEjemplo) return;
    overlayEjemplo.classList.add('open');
    modalSearchEjemplo.value = '';
    renderModalEjemplos('');
    setTimeout(()=>modalSearchEjemplo.focus(), 50);
  }
  function cerrarModalEjemplo(){
    overlayEjemplo.classList.remove('open');
  }

  function renderModalEjemplos(filtro){
    const data = Array.isArray(window.TB_EjemploFormato) ? window.TB_EjemploFormato : [];
    const f = (filtro || '').toLowerCase();
    modalEjemploList.innerHTML = '';

    const filtrados = data.filter(e =>
      e.Genero.toLowerCase().includes(f) ||
      e.TituloEjemplo.toLowerCase().includes(f) ||
      (e.AlbumEjemplo || '').toLowerCase().includes(f) ||
      (e.Descripcion || '').toLowerCase().includes(f)
    );

    if (!filtrados.length){
      const divEmpty = document.createElement('div');
      divEmpty.className = 'modal-empty';
      divEmpty.textContent = 'No se encontraron ejemplos con ese filtro.';
      modalEjemploList.appendChild(divEmpty);
      return;
    }

    filtrados.forEach(e => {
      const it = document.createElement('div');
      it.className = 'modal-item mod-ejemplo';
      it.innerHTML = `
        <div><strong>${e.Genero}</strong></div>
        <div class="mod-ejemplo-titulo">üéµ ${e.TituloEjemplo}</div>
        <div class="mod-ejemplo-album">üíΩ ${e.AlbumEjemplo || ''}</div>
        <div class="mod-ejemplo-desc">${e.Descripcion || ''}</div>
      `;
      it.addEventListener('click', () => {
        if (resultadoTxt) resultadoTxt.value = e.TituloEjemplo;
        if (albumTxt) albumTxt.value = e.AlbumEjemplo || '';
        cerrarModalEjemplo();
      });
      modalEjemploList.appendChild(it);
    });
  }

  btnCloseEjemplo?.addEventListener('click', cerrarModalEjemplo);
  overlayEjemplo?.addEventListener('click', e=>{
    if (e.target === overlayEjemplo) cerrarModalEjemplo();
  });
  modalSearchEjemplo?.addEventListener('input', e=>renderModalEjemplos(e.target.value));

  // Crear bot√≥n "Abrir lista grande" al lado del input de ejemplos (lo inserta bdMusicLite)
  document.addEventListener('DOMContentLoaded', () => {
    const ejemploInputMini = document.getElementById('searchEjemplo');
    if (ejemploInputMini && !document.getElementById('btnOpenEjemploModal')) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.id   = 'btnOpenEjemploModal';
      btn.className = 'btn-open-modal';
      btn.textContent = 'üìã Abrir lista grande';
      ejemploInputMini.insertAdjacentElement('afterend', btn);
      btn.addEventListener('click', abrirModalEjemplo);
    }
  });

  // ESC cierra el modal que est√© abierto
  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape'){
      if(overlayGenero?.classList.contains('open')) cerrarModalGenero();
      if(overlayEvento?.classList.contains('open')) cerrarModalEvento();
      if(overlayEjemplo?.classList.contains('open')) cerrarModalEjemplo();
    }
  });
  
  // === Hacer que Evento, Fase y Ejemplos seleccionen todo el texto al enfocar ===
document.addEventListener('DOMContentLoaded', () => {
  const ids = ['searchEvento', 'searchFase', 'searchEjemplo'];

  ids.forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;

    // Al recibir foco: seleccionar todo
    input.addEventListener('focus', function () {
      this.select();
    });

    // Truco: evitar que el mouseup quite la selecci√≥n en el primer click
    input.addEventListener('mouseup', function (e) {
      // Solo la primera vez tras el foco
      e.preventDefault();
    });
  });
});

// =================== Biblioteca Local: √≠ndice + b√∫squeda ===================
(function(){
  const KEY_INDEX = 'MUSICLIB_INDEX_V1';
  const KEY_UPDATED = 'MUSICLIB_UPDATED_AT';

  const btnPick   = document.getElementById('btnPickFolder');
  const btnOpen   = document.getElementById('btnOpenLocalModal');
  const btnClear  = document.getElementById('btnClearLocal');
  const inputFB   = document.getElementById('inputFolderFallback');

  const overlay   = document.getElementById('modalLocalOverlay');
  const btnClose  = document.getElementById('btnCloseLocalModal');
  const listEl    = document.getElementById('modalLocalList');
  const searchEl  = document.getElementById('searchLocal');
  const metaChip  = document.getElementById('localMetaChip');

  // Utils -------------------------------------------------------
  const nowISO = ()=> new Date().toISOString();
  const saveIndex = (rows)=>{
    try{
      localStorage.setItem(KEY_INDEX, JSON.stringify(rows));
      localStorage.setItem(KEY_UPDATED, nowISO());
    }catch(e){
      alert("No se pudo guardar el √≠ndice. Puede que sea muy grande para localStorage.\nSugerencia: limita la carpeta o usa subcarpetas.");
    }
    refreshMeta();
  };
  const loadIndex = ()=>{
    try{
      const raw = localStorage.getItem(KEY_INDEX);
      return raw ? JSON.parse(raw) : [];
    }catch{ return []; }
  };
  const refreshMeta = ()=>{
    const rows = loadIndex();
    const ts = localStorage.getItem(KEY_UPDATED);
    metaChip.textContent = rows.length
      ? `Indexados: ${rows.length} ‚Ä¢ ${formatDate(ts)}`
      : 'Sin √≠ndice cargado';
  };
  const formatDate = (iso)=>{
    if(!iso) return '';
    const d = new Date(iso);
    return d.toLocaleString();
  };
  const stripExt = (name)=>{
    const i = name.lastIndexOf('.');
    return i > 0 ? name.slice(0, i) : name;
  };
  const norm = (s)=> (s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, ''); // quita acentos

  // Render ------------------------------------------------------
  const renderList = (rows, filtro)=>{
    const f = norm(filtro || '');
    listEl.innerHTML = '';
    const data = f
      ? rows.filter(r => (r.n.includes(f) || r.p.includes(f)))
      : rows;

    if(!data.length){
      const empty = document.createElement('div');
      empty.className = 'local-empty';
      empty.textContent = 'No hay resultados. Carga una carpeta o prueba otro texto.';
      listEl.appendChild(empty);
      return;
    }

    data.slice(0, 5000).forEach(r=>{
      const div = document.createElement('div');
      div.className = 'local-list-item';
      div.innerHTML = `<div class="local-name">üéµ ${r.name}</div>
                       <div class="local-path">${r.path}</div>`;
      // Al hacer click puedes decidir qu√© hacer. Ejemplo: pegar en "resultado"
      div.addEventListener('click', ()=>{
        // Rellena ‚ÄúArtista del √Ålbum‚Äù con el nombre del archivo (sin extensi√≥n)
        const out = document.getElementById('resultado');
        if(out){ out.value = r.name; }
        // O tambi√©n podr√≠as pegar al ‚ÄúBailable‚Äù si est√°s en Mixz:
        const bail = document.getElementById('bailableText');
        if(bail && document.querySelector('input[name="version"][value="Mixz"]')?.checked){
          bail.value = r.name;
        }
      });
      listEl.appendChild(div);
    });
  };

  // Modal open/close -------------------------------------------
  const openModal = ()=>{
    overlay.classList.add('open');
    searchEl.value = '';
    renderList(loadIndex(), '');
    setTimeout(()=> searchEl.focus(), 50);
  };
  const closeModal = ()=> overlay.classList.remove('open');

  btnOpen?.addEventListener('click', openModal);
  btnClose?.addEventListener('click', closeModal);
  overlay?.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape' && overlay?.classList.contains('open')) closeModal();
  });
  searchEl?.addEventListener('input', e => renderList(loadIndex(), e.target.value));

  // Carga de carpeta (FS Access API o fallback webkitdirectory) ----------------
  btnPick?.addEventListener('click', async ()=>{
    if('showDirectoryPicker' in window){
      try{
        const dirHandle = await window.showDirectoryPicker({ id: 'music-lib' });
        const rows = [];
        await traverseDirectory(dirHandle, '', rows);
        indexAndSave(rows);
        alert(`Listo: ${rows.length} archivos indexados.`);
      }catch(err){
        if(err?.name !== 'AbortError') alert('No se pudo leer la carpeta.');
      }
    }else{
      // Fallback
      inputFB.click();
    }
  });

  inputFB?.addEventListener('change', ()=>{
    const files = Array.from(inputFB.files || []);
    const rows = files.map(f=>{
      const rel = f.webkitRelativePath || f.name;
      return { path: rel.replace(/\\/g,'/'), name: stripExt(f.name) };
    }).filter(r => isAudio(r.path));
    indexAndSave(rows);
    alert(`Listo: ${rows.length} archivos indexados (fallback).`);
    inputFB.value = '';
  });

  function isAudio(p){
    return /\.(mp3|wav|m4a|flac|ogg|aac)$/i.test(p);
  }

  async function traverseDirectory(dirHandle, basePath, out){
    for await (const [name, handle] of dirHandle.entries()){
      if(handle.kind === 'file'){
        if(isAudio(name)){
          out.push({ path: (basePath ? basePath + '/' : '') + name, name: stripExt(name) });
        }
      }else if(handle.kind === 'directory'){
        await traverseDirectory(handle, (basePath ? basePath + '/' : '') + name, out);
      }
    }
  }

  function indexAndSave(rows){
    // √çndice buscable: guardamos name, path y versiones normalizadas
    const indexed = rows.map(r => ({
      name: r.name,
      path: r.path,
      n: norm(r.name),
      p: norm(r.path)
    }));
    saveIndex(indexed);
    refreshMeta();
  }

  btnClear?.addEventListener('click', ()=>{
    localStorage.removeItem(KEY_INDEX);
    localStorage.removeItem(KEY_UPDATED);
    refreshMeta();
    alert('Cach√© de biblioteca borrada.');
  });

  // Inicializa chip de meta al cargar
  document.addEventListener('DOMContentLoaded', refreshMeta);
})();

</script>

</body>
</html>
