<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<title>Music Tags ‚Ä¢ DJ Toolkit</title>

<style>
  :root{
    --bg:#0f0f12; --card:#17181d; --card-2:#1e2026; --text:#e8eef6; --muted:#9aa4b2;
    --brand:#00e6e6; --brand-2:#62fff6; --ring:0 0 0 2px rgba(0,230,230,.25);
    --shadow:0 6px 22px rgba(0,0,0,.33); 
    --radius:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI Emoji","Noto Color Emoji","Apple Color Emoji",sans-serif;
    background:radial-gradient(1000px 700px at 20% -10%, #122027 0%, transparent 60%), var(--bg);
    color:var(--text);
    -webkit-tap-highlight-color:transparent;
    overflow-x:hidden;
  }

  /* ---------- WRAP REDUCIDO ---------- */
  .wrap{
    width:min(900px,94vw);
    margin:0 auto;
    padding:calc(env(safe-area-inset-top,0px)+14px) 0 30px;
  }

  /* ---------- T√çTULOS M√ÅS COMPACTOS ---------- */
  .title{
    display:flex;gap:.55rem;align-items:center;
    color:var(--brand);
    margin:6px 4px 10px;
    font-weight:800;letter-spacing:.2px;font-size:1.28rem;
    text-shadow:0 0 16px rgba(0,230,230,.18);
  }

  /* ---------- CARDS REDUCIDAS ---------- */
  .card{
    background:linear-gradient(180deg,var(--card) 0%,var(--card-2) 100%);
    border-radius:var(--radius);
    padding:11px 12px;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.05);
    margin:8px 0 14px;
    position:relative;
  }

  /* ---------- GRID DE RADIOS ---------- */
  .radio-grid{display:grid;gap:8px;grid-template-columns:1fr}
  @media(min-width:620px){.radio-grid{grid-template-columns:1fr 1fr}}

  .radio-chip{
    display:flex;align-items:center;gap:.65rem;
    padding:10px 12px;border-radius:10px;
    background:#121317;
    border:1px solid rgba(255,255,255,.06);
    transition:.12s ease;
    cursor:pointer;min-height:40px;
    font-size:.92rem;
  }
  .radio-chip:hover{background:#15161b;border-color:rgba(255,255,255,.12)}
  .radio-chip input{
    appearance:none;width:16px;height:16px;border-radius:50%;
    border:2px solid var(--brand);
  }
  .radio-chip input:checked{
    background:var(--brand);
    box-shadow:inset 0 0 0 3px #121317;
  }

  /* ---------- SELECTORS ---------- */
  .selectors{
    display:grid;gap:10px;grid-template-columns:1fr;
    margin-top:4px;
  }
  @media(min-width:720px){.selectors{grid-template-columns:1fr 1fr}}

  .sub{
    font-size:.82rem;
    font-weight:700;
    color:var(--muted);
    margin-bottom:3px;
    letter-spacing:.03em;
  }

  .search-box input,
  .bpm-box input{
    width:100%;
    height:40px;
    padding:8px 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.08);
    background:#0e1014;
    color:var(--text);
    font-size:.9rem;
    transition:.12s;
  }
  .search-box input:focus,
  .bpm-box input:focus{
    box-shadow:var(--ring);
    border-color:rgba(0,230,230,.35);
  }

  /* ---------- LISTAS DESPLEGABLES ---------- */
  .list{
    position:absolute;
    top:calc(100% + 5px);
    left:0;right:0;
    max-height:170px;overflow:auto;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.06);
    background:#0e1014;
    z-index:9999;
    box-shadow:0 12px 26px rgba(0,0,0,.42);
  }
  .item{
    padding:10px 12px;cursor:pointer;
    border-bottom:1px solid rgba(255,255,255,.05);
    font-size:.92rem;
  }
  .item:hover{background:#16181d}

  /* ---------- GRUPO VERSION ---------- */
  .version-group{
    display:flex;flex-wrap:wrap;gap:10px;
    padding:4px 8px;margin:4px 0 6px;
    background:#121317;border:1px solid rgba(255,255,255,.07);
    border-radius:8px;color:var(--muted);
    font-size:.85rem;
  }
  .version-group input[type="checkbox"],
  .version-group input[type="radio"]{
    width:15px;height:15px;accent-color:var(--brand);
  }

  /* ---------- RESULTADOS ---------- */
  .results-grid{
    display:grid;gap:8px;grid-template-columns:1fr 1fr;
  }
  @media(max-width:720px){.results-grid{grid-template-columns:1fr}}

  textarea.result{
    width:100%;height:46px;
    padding:10px 12px;
    background:#0d0f13;color:var(--brand-2);
    border:1px solid rgba(0,230,230,.35);
    border-radius:10px;resize:none;
    font-size:.9rem;line-height:1.18;
  }
  #albumText{
    color:#dfe6f3;border-color:rgba(255,255,255,.14);
  }

  /* ---------- BOTONES ---------- */
  .btn{
    min-width:95px;min-height:46px;
    padding:0 16px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,#0f1116 0%,#10141b 100%);
    color:var(--text);
    font-size:.9rem;font-weight:700;
    cursor:pointer;
  }
  .btn--brand{
    background:linear-gradient(180deg,rgba(0,230,230,.22) 0%,rgba(0,230,230,.10) 100%);
    border-color:rgba(0,230,230,.35);
  }
  .btn-open-modal{
    margin-top:5px;align-self:flex-end;
    padding:3px 8px;border-radius:999px;
    font-size:.72rem;color:var(--muted);
    border:1px solid rgba(255,255,255,.15);
  }

  /* ---------- MODALES REDUCIDOS ---------- */
  .modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.7);
    display:none;align-items:center;justify-content:center;
    padding:16px;z-index:100000;
  }
  .modal-overlay.open{display:flex;}

  .modal-box{
    width:min(680px, 100%);
    background:#fff;color:#111;
    border-radius:10px;
    overflow:hidden;
    max-height:88vh;
    display:flex;flex-direction:column;
    box-shadow:0 10px 32px rgba(0,0,0,.6);
  }

  .modal-header{
    background:#222;color:#fff;
    padding:8px 12px;font-weight:700;
    font-size:.95rem;
    display:flex;align-items:center;justify-content:space-between;
  }

  .modal-body{
    padding:10px 12px;gap:8px;
    display:flex;flex-direction:column;flex:1;
  }

  .modal-item{
    padding:8px 10px;font-size:.9rem;
  }

  /* Biblioteca local */
  .modal-tools{
    display:flex;gap:6px;flex-wrap:wrap;
  }
  .btn-mini{
    padding:5px 8px;font-size:.78rem;
    border-radius:8px;border:1px solid #ddd;background:#fff;
  }

</style>
</head>
<body>

<div class="wrap">

  <!-- ===================== ESTADO ===================== -->
  <div class="title">üßæ Estado del Tema</div>
  <section class="card">
    <div id="estadoGroup" class="radio-grid"></div>
  </section>

  <!-- ===================== POPULARIDAD ===================== -->
  <div class="title">üìä Popularidad</div>
  <section class="card">
    <div id="popularidadGroup" class="radio-grid"></div>
  </section>

  <!-- ===================== G√âNERO ¬∑ EVENTO ¬∑ FASE ¬∑ BPM ===================== -->
  <div class="title">üéµ G√©nero ¬∑ üè∑Ô∏è Evento ¬∑ üéõÔ∏è Fase ¬∑ ‚è±Ô∏è BPM</div>
  <section class="card">
    <div class="selectors">

      <!-- ======== G√âNERO ======== -->
      <div class="search-box">
        <div class="sub">G√©nero</div>

        <div class="version-group">
          <label><input type="checkbox" id="chkGrupoAlVivo"> Grupo Al Vivo</label>
          <label><input type="radio" name="version" value="Original" checked> Original</label>
          <label><input type="radio" name="version" value="Rmxz"> Rmxz</label>
          <label><input type="radio" name="version" value="Mixz"> Mixz</label>
        </div>

        <input type="text" id="searchGenero" placeholder="Buscar g√©nero‚Ä¶" autocomplete="off" />
        <button type="button" id="btnOpenGeneroModal" class="btn-open-modal">üìã Abrir lista grande</button>

        <div id="generoList" class="list"></div>

        <div class="hint">
          <span class="hint-label">Nota:</span>
          <span class="hint-text" id="notaGenero">(Selecciona un g√©nero para ver su nota BPM)</span>
        </div>
      </div>

      <!-- ======== EVENTO ======== -->
      <div class="search-box">
        <div class="sub">Evento</div>

        <input type="text" id="searchEvento" placeholder="Buscar evento‚Ä¶" autocomplete="off" />
        <button type="button" id="btnOpenEventoModal" class="btn-open-modal">üìã Abrir lista grande</button>

        <div id="eventoList" class="list"></div>
      </div>

      <!-- ======== FASE ======== -->
      <div class="search-box">
        <div class="sub">Fase del set</div>

        <input type="text" id="searchFase" placeholder="Warm-up, Build-Up, Cl√≠max‚Ä¶" autocomplete="off" />
        <div id="faseList" class="list"></div>
      </div>

      <!-- ======== BPM ======== -->
      <div class="bpm-box">
        <div class="sub">
          BPM
          <label style="margin-left:8px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="chkUsarBpm" checked style="accent-color: var(--brand); transform:scale(1.15);" />
            Usar
          </label>
        </div>

        <input type="number" id="bpm" placeholder="Ej. 95" min="50" max="220" step="1" inputmode="numeric" />
      </div>

    </div>
  </section>

  <!-- ===================== RESULTADOS ===================== -->
  <div class="title">üìå Resultados</div>
  <section class="card">
    <div class="results-grid">

      <!-- ARTISTA -->
      <div class="result-card">
        <div class="textarea-box">
          <div class="sub">üé§ Artista del √Ålbum</div>
          <textarea id="resultado" class="result" readonly></textarea>
        </div>
        <button id="btnCopyMain" class="btn btn--brand">Copiar</button>
      </div>

      <!-- √ÅLBUM -->
      <div class="result-card">
        <div class="textarea-box">
          <div class="sub">üíø √Ålbum</div>
          <textarea id="albumText" class="result" readonly></textarea>
        </div>
        <button id="btnCopyAlbum" class="btn">Copiar</button>
      </div>

      <!-- MIXZ EXTRA -->
      <div class="result-card" id="mixzCard" style="display:none;">
        <div style="flex:1;display:flex;flex-direction:column">
          <div class="sub">üé§ Artista: Bailable</div>
          <textarea id="bailableText" class="result" placeholder="Escribe el artista o tipo de mix..."></textarea>
        </div>
        <button id="btnCopyBailable" class="btn">Copiar</button>
      </div>

    </div>

    <!-- RESET -->
    <div class="reset-row" style="margin-top:8px; display:flex; justify-content:center;">
      <button id="btnReset" class="btn btn--reset"
        style="min-width:150px; background:linear-gradient(180deg,#461616 0%,#2a0d0d 100%); border-color:#d22;">
        üîÑ Restablecer
      </button>
    </div>

  </section>
</div>

<!-- ===================== MODAL G√âNERO ===================== -->
<div id="modalGeneroOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üéµ Modal de G√©nero</div>
      <button type="button" id="btnCloseGeneroModal" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="text" id="modalSearchGenero" placeholder="Buscar g√©nero‚Ä¶" autocomplete="off" />
      <div id="modalGeneroList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- ===================== MODAL EVENTO ===================== -->
<div id="modalEventoOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üè∑Ô∏è Modal de Evento</div>
      <button type="button" id="btnCloseEventoModal" class="modal-close">&times;</button>
    </div>

    <div class="modal-body">
      <input type="text" id="modalSearchEvento" placeholder="Buscar evento‚Ä¶" autocomplete="off" />
      <div id="modalEventoChips" class="modal-chips"></div>
      <div id="modalEventoList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- ===================== MODAL EJEMPLOS FORMATO ===================== -->
<div id="modalEjemploOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üìò Ejemplos de Formato</div>
      <button type="button" id="btnCloseEjemploModal" class="modal-close">&times;</button>
    </div>

    <div class="modal-body">
      <input type="text" id="modalSearchEjemplo" placeholder="Buscar‚Ä¶" autocomplete="off" />
      <div id="modalEjemploList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- ===================== BIBLIOTECA LOCAL ===================== -->
<div class="wrap" style="margin-top:-6px;">
  <section class="card" style="padding:8px 12px;">
    <div class="row-between" style="display:flex; justify-content:space-between; align-items:center;">
      <div class="sub" style="font-size:.85rem;">üéº Biblioteca local</div>

      <div class="modal-tools">
        <button id="btnPickFolder" class="btn-mini brand"
          style="border-color:#00e6e6; box-shadow:0 0 0 2px rgba(0,230,230,.15) inset;">
          üìÅ Cargar
        </button>
        <button id="btnOpenLocalModal" class="btn-mini">üîé Buscar</button>
        <button id="btnClearLocal" class="btn-mini">üóëÔ∏è Borrar</button>
      </div>
    </div>
  </section>
</div>

<!-- Fallback -->
<input id="inputFolderFallback" type="file" webkitdirectory multiple style="display:none" />

<!-- Modal Biblioteca -->
<div id="modalLocalOverlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üéº Biblioteca local</div>
      <button type="button" id="btnCloseLocalModal" class="modal-close">&times;</button>
    </div>

    <div class="modal-body">
      <div class="modal-tools" style="justify-content:space-between;">
        <input type="text" id="searchLocal" placeholder="Buscar en biblioteca‚Ä¶" autocomplete="off" />
        <span class="modal-chip" id="localMetaChip">Sin √≠ndice cargado</span>
      </div>

      <div id="modalLocalList" class="modal-list"></div>
    </div>
  </div>
</div>

<!-- Base de datos -->
<script src="bdMusicData.js"></script>
<script src="bdMusicLite.js"></script>

<script>
/* ===========================
   COPIAR RESULTADOS
   =========================== */
function fallbackCopy(id){
  const el = document.getElementById(id);
  el.select();
  document.execCommand('copy');
}
function flashBtn(id){
  const btn = document.getElementById(id);
  const old = btn.textContent;
  btn.textContent = '¬°Copiado!';
  setTimeout(()=>btn.textContent = old, 1200);
}

document.getElementById('btnCopyMain').addEventListener('click', async () => {
  const txt = document.getElementById('resultado').value.trim();
  try{ await navigator.clipboard.writeText(txt); }
  catch(e){ fallbackCopy('resultado'); }
  flashBtn('btnCopyMain');
});

document.getElementById('btnCopyAlbum').addEventListener('click', async () => {
  const txt = document.getElementById('albumText').value.trim();
  try{ await navigator.clipboard.writeText(txt); }
  catch(e){ fallbackCopy('albumText'); }
  flashBtn('btnCopyAlbum');
});

document.getElementById('btnCopyBailable').addEventListener('click', async () => {
  const txt = document.getElementById('bailableText').value.trim();
  try{ await navigator.clipboard.writeText(txt); }
  catch(e){ fallbackCopy('bailableText'); }
  flashBtn('btnCopyBailable');
});


/* ===========================
   RESET COMPLETO
   =========================== */
document.getElementById('btnReset').addEventListener('click', () => {
  [
    "estadoTag","popularidadTag","generoTag","eventoTag","faseTag",
    "bpmTag","usarBpm","versionTag","grupoAlVivo"
  ].forEach(k => localStorage.removeItem(k));
  location.reload();
});


/* =============================================================
   MARCADO VISUAL DE RADIO-CHIPS (Estado / Popularidad)
   ============================================================= */
document.addEventListener('change', (ev)=>{
  if(ev.target.matches('input[name="estado"], input[name="popularidad"]')){
    const group = ev.target.name === 'estado' ? '#estadoGroup' : '#popularidadGroup';
    document.querySelectorAll(group + ' .radio-chip')
      .forEach(l => l.classList.remove('is-checked'));
    ev.target.closest('.radio-chip')?.classList.add('is-checked');
  }
});


/* =============================================================
   MODAL G√âNERO
   ============================================================= */

const overlayGenero       = document.getElementById('modalGeneroOverlay');
const btnOpenGenero       = document.getElementById('btnOpenGeneroModal');
const btnCloseGenero      = document.getElementById('btnCloseGeneroModal');
const modalSearchGenero   = document.getElementById('modalSearchGenero');
const modalGeneroList     = document.getElementById('modalGeneroList');
const generoInputMain     = document.getElementById('searchGenero');

function abrirModalGenero(){
  overlayGenero.classList.add('open');
  modalSearchGenero.value = '';
  renderModalGeneros('');
  setTimeout(()=>modalSearchGenero.focus(), 50);
}
function cerrarModalGenero(){
  overlayGenero.classList.remove('open');
}
function renderModalGeneros(filtro){
  const f = (filtro||'').toLowerCase();
  modalGeneroList.innerHTML = '';

  window.TB_Genero
    .filter(g => g.Estado === 'ACT' && g.Nombre.toLowerCase().includes(f))
    .forEach(g => {
      const div = document.createElement('div');
      div.className = 'modal-item';

      let emoji = 'üéµ';
      let texto = g.Nombre;

      try{
        const m = g.Nombre.match(/^(\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*(.*)$/u);
        if(m){ if(m[1]) emoji = m[1]; if(m[2]) texto = m[2]; }
      }catch{}

      div.innerHTML = `<span class="emoji">${emoji}</span> <span>${texto}</span>`;

      div.addEventListener('click', ()=>{
        generoInputMain.value = g.Nombre;
        generoInputMain.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'}));
        cerrarModalGenero();
      });

      modalGeneroList.appendChild(div);
    });
}

btnOpenGenero.addEventListener('click', abrirModalGenero);
btnCloseGenero.addEventListener('click', cerrarModalGenero);
overlayGenero.addEventListener('click', e=>{ if(e.target===overlayGenero) cerrarModalGenero(); });
modalSearchGenero.addEventListener('input', e=>renderModalGeneros(e.target.value));


/* =============================================================
   MODAL EVENTO (con filtros por emoji)
   ============================================================= */

const overlayEvento       = document.getElementById('modalEventoOverlay');
const btnOpenEvento       = document.getElementById('btnOpenEventoModal');
const btnCloseEvento      = document.getElementById('btnCloseEventoModal');
const modalSearchEvento   = document.getElementById('modalSearchEvento');
const modalEventoList     = document.getElementById('modalEventoList');
const modalEventoChips    = document.getElementById('modalEventoChips');
const eventoInputMain     = document.getElementById('searchEvento');

const _rawEventos = Array.isArray(window.TB_TipoEvento)
  ? window.TB_TipoEvento
  : (Array.isArray(window.TB_Evento) ? window.TB_Evento : []);

const EV_DATA = _rawEventos.map(e => {
  let emoji='üè∑Ô∏è'; let texto=e.Nombre;
  try{
    const m=e.Nombre.match(/^(\p{Emoji_Presentation}|\p{Extended_Pictographic})?\s*(.*)$/u);
    if(m){ if(m[1]) emoji=m[1]; if(m[2]) texto=m[2]; }
  }catch{}
  return {...e, emoji, texto};
});

const EV_EMOJIS = Array.from(new Set(EV_DATA.map(e=>e.emoji)));
let filtroEmojiEvento = 'ALL';

function construirChipsEvento(){
  modalEventoChips.innerHTML = '';

  const chipAll = document.createElement('button');
  chipAll.className='chip-filter chip-filter--active';
  chipAll.dataset.emoji='ALL';
  chipAll.innerHTML=`<span class="emoji">‚≠ê</span><span>Todos</span>`;
  chipAll.addEventListener('click', onChipEventoClick);
  modalEventoChips.appendChild(chipAll);

  EV_EMOJIS.forEach(em=>{
    const chip = document.createElement('button');
    chip.className='chip-filter';
    chip.dataset.emoji=em;
    chip.innerHTML=`<span class="emoji">${em}</span><span>${em}</span>`;
    chip.addEventListener('click', onChipEventoClick);
    modalEventoChips.appendChild(chip);
  });
}

function onChipEventoClick(ev){
  filtroEmojiEvento = ev.currentTarget.dataset.emoji;
  document.querySelectorAll('#modalEventoChips .chip-filter')
    .forEach(c => c.classList.toggle('chip-filter--active', c.dataset.emoji===filtroEmojiEvento));
  renderModalEventos(modalSearchEvento.value);
}

function abrirModalEvento(){
  overlayEvento.classList.add('open');
  modalSearchEvento.value='';
  filtroEmojiEvento='ALL';
  construirChipsEvento();
  renderModalEventos('');
  setTimeout(()=>modalSearchEvento.focus(),50);
}
function cerrarModalEvento(){
  overlayEvento.classList.remove('open');
}

function renderModalEventos(filtro){
  const f=(filtro||'').toLowerCase();
  modalEventoList.innerHTML='';

  const filtrados = EV_DATA
    .filter(e => !e.Estado || e.Estado==='ACT')
    .filter(e => filtroEmojiEvento==='ALL' || e.emoji===filtroEmojiEvento)
    .filter(e => e.Nombre.toLowerCase().includes(f));

  if(!filtrados.length){
    const divEmpty=document.createElement('div');
    divEmpty.className='modal-empty';
    divEmpty.textContent='No se encontraron eventos.';
    modalEventoList.appendChild(divEmpty);
    return;
  }

  filtrados.forEach(e=>{
    const div=document.createElement('div');
    div.className='modal-item';
    div.innerHTML=`<span class="emoji">${e.emoji}</span> <span>${e.texto}</span>`;
    div.addEventListener('click', ()=>{
      eventoInputMain.value=e.Nombre;
      eventoInputMain.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'}));
      cerrarModalEvento();
    });
    modalEventoList.appendChild(div);
  });
}

btnOpenEvento.addEventListener('click', abrirModalEvento);
btnCloseEvento.addEventListener('click', cerrarModalEvento);
overlayEvento.addEventListener('click', e=>{ if(e.target===overlayEvento) cerrarModalEvento(); });
modalSearchEvento.addEventListener('input', e=>renderModalEventos(e.target.value));


/* =============================================================
   MODAL EJEMPLOS DE FORMATO
   ============================================================= */

const overlayEjemplo      = document.getElementById('modalEjemploOverlay');
const btnCloseEjemplo    = document.getElementById('btnCloseEjemploModal');
const modalSearchEjemplo = document.getElementById('modalSearchEjemplo');
const modalEjemploList   = document.getElementById('modalEjemploList');
const resultadoTxt       = document.getElementById('resultado');
const albumTxt           = document.getElementById('albumText');

function abrirModalEjemplo(){
  overlayEjemplo.classList.add('open');
  modalSearchEjemplo.value='';
  renderModalEjemplos('');
  setTimeout(()=>modalSearchEjemplo.focus(),50);
}
function cerrarModalEjemplo(){
  overlayEjemplo.classList.remove('open');
}

function renderModalEjemplos(filtro){
  const data=Array.isArray(window.TB_EjemploFormato)?window.TB_EjemploFormato:[];
  const f=(filtro||'').toLowerCase();
  modalEjemploList.innerHTML='';

  const filtrados = data.filter(e =>
    e.Genero.toLowerCase().includes(f) ||
    e.TituloEjemplo.toLowerCase().includes(f) ||
    (e.AlbumEjemplo||'').toLowerCase().includes(f) ||
    (e.Descripcion||'').toLowerCase().includes(f)
  );

  if(!filtrados.length){
    const divEmpty=document.createElement('div');
    divEmpty.className='modal-empty';
    divEmpty.textContent='No se encontraron ejemplos.';
    modalEjemploList.appendChild(divEmpty);
    return;
  }

  filtrados.forEach(e=>{
    const it=document.createElement('div');
    it.className='modal-item mod-ejemplo';
    it.innerHTML=`
      <div><strong>${e.Genero}</strong></div>
      <div class="mod-ejemplo-titulo">üéµ ${e.TituloEjemplo}</div>
      <div class="mod-ejemplo-album">üíΩ ${e.AlbumEjemplo||''}</div>
      <div class="mod-ejemplo-desc">${e.Descripcion||''}</div>
    `;
    it.addEventListener('click',()=>{
      resultadoTxt.value=e.TituloEjemplo;
      albumTxt.value=e.AlbumEjemplo||'';
      cerrarModalEjemplo();
    });
    modalEjemploList.appendChild(it);
  });
}

overlayEjemplo.addEventListener('click', e=>{ if(e.target===overlayEjemplo) cerrarModalEjemplo(); });
btnCloseEjemplo.addEventListener('click', cerrarModalEjemplo);
modalSearchEjemplo.addEventListener('input', e=>renderModalEjemplos(e.target.value));


/* =============================================================
   INPUTS: seleccionar todo al tocar (Evento/Fase)
   ============================================================= */
['searchEvento','searchFase'].forEach(id=>{
  const input=document.getElementById(id);
  if(!input) return;

  input.addEventListener('focus', function(){ this.select(); });
  input.addEventListener('mouseup', function(e){ e.preventDefault(); });
});


/* =============================================================
   MODAL BIBLIOTECA LOCAL
   ============================================================= */

(function(){
  const KEY_INDEX='MUSICLIB_INDEX_V1';
  const KEY_UPDATED='MUSICLIB_UPDATED_AT';

  const btnPick   = document.getElementById('btnPickFolder');
  const btnOpen   = document.getElementById('btnOpenLocalModal');
  const btnClear  = document.getElementById('btnClearLocal');
  const inputFB   = document.getElementById('inputFolderFallback');

  const overlay   = document.getElementById('modalLocalOverlay');
  const btnClose  = document.getElementById('btnCloseLocalModal');
  const listEl    = document.getElementById('modalLocalList');
  const searchEl  = document.getElementById('searchLocal');
  const metaChip  = document.getElementById('localMetaChip');

  const nowISO = ()=>new Date().toISOString();
  const saveIndex = rows=>{
    try{
      localStorage.setItem(KEY_INDEX, JSON.stringify(rows));
      localStorage.setItem(KEY_UPDATED, nowISO());
    }catch(e){
      alert("√çndice demasiado grande para localStorage.");
    }
    refreshMeta();
  };
  const loadIndex = ()=>{
    try{
      const raw=localStorage.getItem(KEY_INDEX);
      return raw?JSON.parse(raw):[];
    }catch{return [];}
  };
  const refreshMeta = ()=>{
    const rows=loadIndex();
    const ts=localStorage.getItem(KEY_UPDATED);
    metaChip.textContent = rows.length
      ? `Indexados: ${rows.length} ‚Ä¢ ${new Date(ts).toLocaleString()}`
      : 'Sin √≠ndice cargado';
  };

  /* Render */
  const renderList = (rows, filtro)=>{
    const f=normalize(filtro);
    listEl.innerHTML='';
    const data = f
      ? rows.filter(r => r.n.includes(f) || r.p.includes(f))
      : rows;

    if(!data.length){
      const empty=document.createElement('div');
      empty.className='local-empty';
      empty.textContent='No hay resultados.';
      listEl.appendChild(empty);
      return;
    }

    data.slice(0,5000).forEach(r=>{
      const div=document.createElement('div');
      div.className='local-list-item';
      div.innerHTML = `
        <div class="local-name">üéµ ${r.name}</div>
        <div class="local-path">${r.path}</div>
      `;
      div.addEventListener('click',()=>{
        const out=document.getElementById('resultado');
        if(out) out.value=r.name;

        const mix = document.querySelector('input[name="version"][value="Mixz"]');
        if(mix?.checked){
          const b=document.getElementById('bailableText');
          if(b) b.value=r.name;
        }
      });
      listEl.appendChild(div);
    });
  };

  /* Normalizar */
  function normalize(s){
    return (s||'').toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'');
  }

  /* Apertura/Cierre */
  const openModal=()=>{
    overlay.classList.add('open');
    searchEl.value='';
    renderList(loadIndex(), '');
    setTimeout(()=>searchEl.focus(),50);
  };
  const closeModal=()=>overlay.classList.remove('open');

  btnOpen.addEventListener('click', openModal);
  btnClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', e=>{ if(e.target===overlay) closeModal(); });
  searchEl.addEventListener('input', e=>renderList(loadIndex(), e.target.value));
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && overlay.classList.contains('open')) closeModal(); });

  /* Indexar carpeta */
  btnPick.addEventListener('click', async ()=>{
    if('showDirectoryPicker' in window){
      try{
        const dirHandle = await window.showDirectoryPicker({id:'music-lib'});
        const rows=[];
        await walk(dirHandle, '', rows);
        indexAndSave(rows);
        alert(`Listo: ${rows.length} archivos indexados.`);
      }catch(e){
        if(e?.name!=='AbortError') alert('Error leyendo carpeta.');
      }
    }else inputFB.click();
  });

  /* Fallback webkitdirectory */
  inputFB.addEventListener('change', ()=>{
    const files=Array.from(inputFB.files||[]);
    const rows = files
      .map(f=>({path:f.webkitRelativePath.replace(/\\/g,'/'), name:stripExt(f.name)}))
      .filter(r=>isAudio(r.path));
    indexAndSave(rows);
    alert(`Listo: ${rows.length} archivos indexados.`);
    inputFB.value='';
  });

  /* Helpers */
  function stripExt(name){
    const i=name.lastIndexOf('.');
    return i>0?name.slice(0,i):name;
  }
  function isAudio(p){
    return /\.(mp3|wav|m4a|flac|ogg|aac)$/i.test(p);
  }
  async function walk(dirHandle, base, out){
    for await(const [name,handle] of dirHandle.entries()){
      if(handle.kind==='file'){
        if(isAudio(name)){
          out.push({path:(base?base+'/':'')+name, name:stripExt(name)});
        }
      }else if(handle.kind==='directory'){
        await walk(handle, (base?base+'/':'')+name, out);
      }
    }
  }

  function indexAndSave(rows){
    const indexed = rows.map(r=>({
      name:r.name,
      path:r.path,
      n:normalize(r.name),
      p:normalize(r.path)
    }));
    saveIndex(indexed);
  }

  btnClear.addEventListener('click', ()=>{
    localStorage.removeItem(KEY_INDEX);
    localStorage.removeItem(KEY_UPDATED);
    refreshMeta();
    alert('Cach√© borrada.');
  });

  document.addEventListener('DOMContentLoaded', refreshMeta);
})();


/* =============================================================
   ESC CIERRA MODALES
   ============================================================= */
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    if(overlayGenero.classList.contains('open')) cerrarModalGenero();
    if(overlayEvento.classList.contains('open')) cerrarModalEvento();
    if(overlayEjemplo.classList.contains('open')) cerrarModalEjemplo();
  }
});
</script>

</body>
</html>
